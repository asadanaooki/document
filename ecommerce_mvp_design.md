# 商品一覧画面 ― 詳細設計

## 1. 機能要件
| 項目 | 内容 |
|------|------|
| URL | `/products?page={n}&sort={new|high|low}&q={keyword}` |
| 表示件数 | 設定ファイルから取得 |
| 並び順 | `new` : created_at DESC, id DESC  /  `high` : price DESC, id DESC  /  `low` : price ASC, id DESC |
| UI | 検索バー・並び替えセレクト・在庫切れバッジ・ページネーション(前/次＋±2) |
| 異常系 | `page<1`→1,  空検索→検索フィルタなしとみなす |

## 2. 画面仕様

| 要素 | 内容 |
|------|------|
| URL | `/products?page={n}&keyword={m}&sort={u}` |
| レイアウト | グリッド (PC 4列 / SP 2列) |
| カード | 画像1枚・商品名(2行切り)・税込価格 |
| 在庫バッジ | `在庫切れ` 灰色 |
| ページネーション | `<< ‹ 1 2 3 › >>`  (最大5頁リンク 現在ページ±2) <br>ページリンクは `q` と `sort` を必ずクエリに保持 |
| 検索バー | XSS対策としてエスケープ |
| エンプティ表示 | 「該当する検索結果は見つかりませんでした」 |

## 3. バリデーションチェック
- **page** ≥ 1
- **sort**
  - 許可値: `new` / `high` / `low`  
  - それ以外は'new'にフォールバック

## 4. 処理フロー

1. **アクセス受付**  
   - 例: `/products?page=2&sort=high&q=%E3%83%8F%E3%83%B3%E3%83%89%20クリーム`  

2. **バリデーションチェック**  
    **[3. バリデーションチェック](#3-バリデーションチェック)** を参照

3. **キーワード分割**  
   - 半角空白で `split` → `keywords[]` 生成。  
   - 配列長 0 なら OR 句を作らず “一覧モード”。

4. **SQL 構築**  

| セクション | 内容 | 可変ポイント |
|------------|------|--------------|
| **SELECT** | `product_id, product_name, price, stock` | ― |
| **FROM**   | `product` | ― |
| **WHERE**  | 1. `sale_status = '0'`<br>2. （検索語ありの場合）<br>&nbsp;&nbsp;&nbsp;`AND (product_name LIKE '%kw1%' OR product_name LIKE '%kw2%' …)` | 検索キーワードが **0 個**なら 2. を省略 |
| **ORDER BY** | - `new`  →  `created_at DESC, product_id DESC`<br>- `high` →  `price DESC,  product_id DESC`<br>- `low`  →  `price ASC,  product_id DESC` | `sort` パラメータで分岐 |
| **LIMIT / OFFSET** | `LIMIT <size> OFFSET <size> × (page-1)` | `page` と `size` パラメータで変動 |

5. **DB 実行 & 結果取得**  
   - 検索結果 (≤ **size** 行) と `COUNT(*)` を取得。  
   - `totalPages = ceil(count / size)` を計算。 

6. **DTO 生成**  
   - 各行 → 商品カード (ID / 名称 / 価格 / 在庫フラグ / サムネ URL)。  
   - `pageNumbers` = **現在ページ ±2 を中心とした最大 5 件のページ番号リスト**を作成


## 4. 保留・後回しメモ ― 何を指しているか

| 項目 | 意味・背景 | 追加タイミングが “ここ” の理由 |
|------|-----------|--------------------------------|
| **FULLTEXT ／ N-gram 検索** | LIKE `%キーワード%` が重くなった際、MySQL の全文検索（`FULLTEXT`・N-gram パーサ）や外部検索エンジンへ切り替えるための布石 | **ヒット 0 件率 > 10 %** になると「探せない」痛みが顕著になるため |
| **カテゴリ絞り込み** | `?cat=ELEC` などカテゴリ ID を WHERE 句に追加。左ナビやパンくずを実装 | **商品数 > 200** になると一覧だけでは目的の商品を探しにくくなるため |
| **長文キーワード上限** | 現状は文字数無制限。DoS や SlowQuery を観測してから `@Size(max=100)` 等で制限を設ける | 実際に遅延が発生しないうちは開発コストを先延ばしに出来るため |
| **無限スクロール** | ページ遷移を Ajax 連続読込に置き換え、モバイル UX を向上 | スマホ比率が上がり UX 投資の費用対効果が高まるフェーズで導入 |

---

## 5. 学習目的で “あえて” 採用している設計ポイント

| 現行設計 | 何を学ぶためか | どんな状況になったら改善するか |
|----------|---------------|--------------------------------|
| **LIKE `%kw%` 全表走査** | フルスキャン → 遅延 → 全文検索へ移行する実務的ステップを体験 | **SlowQuery > 300 ms** が監視で検知されたら |
| **検索語上限なし** | 入力 DoS を実測し、メトリクスドリブンで適切な上限値を決める流れを学ぶ | 平均レイテンシ悪化 or スロークエリ発生 |
| **キャッシュ未使用** | キャッシュ導入前後で **DB 負荷／レイテンシ／ヒット率** を比較し、キャッシュの効果と設計留意点を体験 | 同一クエリ再実行率 > 30% など改善余地が明確になったら → Redis 等でキャッシュ実装 |
